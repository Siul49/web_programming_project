<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¸í„°ë·° ìŠ¤ì¼€ì¤„ëŸ¬</title>
</head>
<body>
<h2>ğŸ“„ ì¸í„°ë·° ìŠ¤ì¼€ì¤„ CSV ì—…ë¡œë“œ</h2>
<input type="file" id="csvInput" accept=".csv" />
<button id="processBtn">ìŠ¤ì¼€ì¤„ ìƒì„± & ë‹¤ìš´ë¡œë“œ</button>

<script>
    class Student {
        constructor(name, personalNum, possibleTime, column, row) {
            this.name = name;
            this.personalNum = personalNum;
            this.column = column;
            this.row = row;
            this.selectCnt = 0;
            this.possibleTable = Array.from({ length: row }, () => Array(column).fill(false));

            let cnt = 0;
            for (const s of possibleTime) {
                if (s.length > 7) {
                    const tokens = s.split(/,\s*/);
                    for (let i = 0; i < column; i++) {
                        try {
                            const day = this.convertDay(tokens[i]);
                            this.possibleTable[cnt][day] = true;
                            this.selectCnt++;
                        } catch (e) {}
                    }
                } else {
                    const day = this.convertDay(s);
                    this.possibleTable[cnt][day] = true;
                    this.selectCnt++;
                }
                cnt++;
            }
        }

        convertDay(token) {
            switch (token.trim()) {
                case "3/10(ì›”)": return 0;
                case "3/11(í™”)": return 1;
                case "3/12(ìˆ˜)": return 2;
                default: return 0;
            }
        }

        isPossible(row, col) {
            return this.possibleTable[row][col];
        }

        deleteTime(row, col) {
            if (this.possibleTable[row][col]) {
                this.possibleTable[row][col] = false;
                this.selectCnt--;
            }
        }
    }

    let csvData = null;

    document.getElementById("csvInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            complete: function(results) {
                csvData = results.data;
                alert("CSV ë¡œë”© ì™„ë£Œ!");
            }
        });
    });

    document.getElementById("processBtn").addEventListener("click", function () {
        if (!csvData) {
            alert("ë¨¼ì € CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
            return;
        }

        const row = 4;
        const col = 3;
        const unit = 2;
        const students = [];
        const map = new Map();

        for (const line of csvData) {
            const [name, personalNum, ...times] = line;
            if (!map.has(personalNum)) {
                map.set(personalNum, true);
                students.push(new Student(name, personalNum, times, col, row));
            }
        }

        const timeTable = Array.from({ length: row }, () => Array(col).fill(""));

        for (let i = 0; i < row; i++) {
            for (let j = 0; j < col; j++) {
                students.sort((a, b) => a.selectCnt - b.selectCnt);

                const selected = [];
                let cnt = 0;

                for (let k = 0; k < students.length && cnt < unit; k++) {
                    if (students[k].isPossible(i, j)) {
                        timeTable[i][j] += `${students[k].name}/${students[k].personalNum}, `;
                        selected.push(students[k].personalNum);
                        cnt++;
                    }
                }

                for (const id of selected) {
                    const idx = students.findIndex(s => s.personalNum === id);
                    if (idx !== -1) students.splice(idx, 1);
                }

                if (timeTable[i][j] !== "") {
                    for (const student of students) {
                        student.deleteTime(i, j);
                    }
                    timeTable[i][j] = timeTable[i][j].replace(/, $/, "");
                }
            }
        }

        const csvString = Papa.unparse(timeTable);
        const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
        saveAs(blob, "schedule.csv");
    });
</script>
</body>
</html>
